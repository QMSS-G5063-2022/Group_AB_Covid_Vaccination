<!DOCTYPE html>
<html lang="en">
<head>
<title>Globe Vaccination Rollout</title>
<meta charset="utf-8">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="style/style.css" type="text/css" media="screen" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@200;300;400;600;700;900&display=swap" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Bevan|Cardo' rel='stylesheet' type='text/css'>
</head>
    <div class="container" style="background-image: url('//unpkg.com/three-globe/example/img/night-sky.png');background-repeat: no-repeat;">
        <div class="row">
            <div class="col-12">
                <div id="main-wrapper", style="text-align: center;padding-top:20px;">
                  <span  style="text-align: center;color: white;font-family: 'Source Sans Pro', sans-serif;font-size:26px;font-weight:200;">At least <span style="font-weight:600;">200 countries</span> have started</span>
                  <br>
                  <span style="text-align: center;color: white;font-family: 'Source Sans Pro', sans-serif;font-size:26px;font-weight:200;">vaccinating against COVID-19 </span>
                  <br>
                    <div id="globeViz">

                    </div>
                </div>
            </div>
        </div>
    </div>
<script src="//unpkg.com/globe.gl"></script>
<script src="//unpkg.com/d3"></script> 


<script>
// create a colour scale #2f3540 to #86b95d
const colorScale = d3.scaleSequentialPow(d3.interpolateGnBu).exponent(0.5);

// centre map at Ghana
const MAP_CENTER = {lat: 33.3942, lng: -97, altitude: 1.8};

// assign url where to find flags
const flagEndpoint = 'https://corona.lmao.ninja/assets/img/flags';

// load in the geojson data
// and set feature I want to plot (trade value)
const getVal = feat => feat.properties.first;
fetch('data/country.geojson').then(res => res.json()).then(countries =>
{

  //const maxVal = Math.max(...countries.features.map(getVal));

  // I have to make sure that in the colour scale I do not include the World Total (Ghana).
  // So, I am setting a manual domain.
  colorScale.domain([0, 1]);

  const world = Globe()
    .height(600)
    .width(1250)
    // by default there is a little map image overlaid, but I do not need that
    //.globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
    // add a nice night sky
    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
    .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
    .polygonsData(countries.features)
    .polygonAltitude(0.02)
    // make countries without data light grey and make Ghana the red colour of the Ghanaian flag
    .polygonCapColor(feat =>  getVal(feat) === -1 ? '#2f3540' : colorScale(getVal(feat)))
    .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)')
    .polygonStrokeColor(()=> 'rgba(255,255,255,0.001)')
    .polygonLabel(
({ properties: d, covidData: c }) => {
const flagName = d.ISO_A2.toLowerCase();
return `
<div class="card"> 
<div class="card-top">
  <img style="padding-top:10px;vertical-align:middle;width:50px;height:40px;" src="${flagEndpoint}/${flagName}.png" alt="flag">
</div>
<p style="margin:0;padding-top:5px;padding-top:0px;font-size:1.3rem;font-weight:600;">${d.NAME}</p>
<div>
   <p style="margin:0;padding:1.2px;"><span style="font-size:1.3rem;font-weight:600;">${d.first === -1  ? 'NA%' : d3.format('.2%')(d.first) }</span><span style="font-weight:300;"> received at least one dose</span></p>
   <p style="margin:0;padding:1.2px;"><span style="font-weight:600;">${d.fully === -1  ? 'NA%' : d3.format('.2%')(d.fully) }</span><span style="font-weight:300;"> have been fully vaccinated</span></p>
</div>
</div>
`
}
)
    .onPolygonHover(hoverD => world
      .polygonAltitude(d => d === hoverD ? 0.1 : 0.02)
      .polygonCapColor(d => d === hoverD ? 'rgb(0, 107, 63)' : getVal(d) === -1 ? '#2f3540' :  colorScale(getVal(d)))
      .polygonStrokeColor(d => d === hoverD ? 'rgb(255,255,255)':'rgba(255,255,255,0.001)')
    )
    .polygonsTransitionDuration(250)
    .pointOfView(MAP_CENTER, 10)
  (document.getElementById('globeViz'));
});


</script>

</html>